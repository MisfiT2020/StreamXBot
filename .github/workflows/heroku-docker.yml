name: Heroku (setup config + Docker web deploy)

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      heroku_app_name:
        description: "Heroku app name (existing or new). Leave empty to use secrets.HEROKU_APP_NAME"
        required: false
        type: string
      heroku_api_key:
        description: "Heroku API key (optional â€“ leave empty to use secrets.HEROKU_API_KEY or secrets.HEROKU_KEY)"
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect Heroku configuration
        run: |
          ENABLED=true

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.heroku_app_name }}" ]; then
            echo "HEROKU_APP_NAME=${{ github.event.inputs.heroku_app_name }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.HEROKU_APP_NAME }}" ]; then
            echo "HEROKU_APP_NAME=${{ secrets.HEROKU_APP_NAME }}" >> $GITHUB_ENV
          else
            ENABLED=false
          fi

          if [ "$ENABLED" = "true" ]; then
            if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.heroku_api_key }}" ]; then
              echo "HEROKU_API_KEY=${{ github.event.inputs.heroku_api_key }}" >> $GITHUB_ENV
            elif [ -n "${{ secrets.HEROKU_API_KEY }}" ]; then
              echo "HEROKU_API_KEY=${{ secrets.HEROKU_API_KEY }}" >> $GITHUB_ENV
            elif [ -n "${{ secrets.HEROKU_KEY }}" ]; then
              echo "HEROKU_API_KEY=${{ secrets.HEROKU_KEY }}" >> $GITHUB_ENV
            else
              ENABLED=false
            fi
          fi

          echo "HEROKU_ENABLED=$ENABLED" >> $GITHUB_ENV

          if [ -n "${{ secrets.CONFIG_GIST }}" ]; then
            echo "GIST_RAW_URL=${{ secrets.CONFIG_GIST }}" >> $GITHUB_ENV
          else
            echo "GIST_RAW_URL=" >> $GITHUB_ENV
          fi

      - name: Ensure Heroku app exists (create if missing)
        if: env.HEROKU_ENABLED == 'true'
        env:
          HEROKU_API_KEY: ${{ env.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ env.HEROKU_APP_NAME }}
        run: |
          echo "Ensuring Heroku app '$HEROKU_APP_NAME' exists..."

          RESPONSE_CODE=$(curl -sS -o /tmp/heroku_app.json -w "%{http_code}" \
            -X POST https://api.heroku.com/apps \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -d "{\"name\":\"$HEROKU_APP_NAME\"}" || echo "000")

          if [ "$RESPONSE_CODE" = "201" ]; then
            echo "Heroku app '$HEROKU_APP_NAME' created."
          elif [ "$RESPONSE_CODE" = "422" ]; then
            echo "Heroku app '$HEROKU_APP_NAME' already exists. Using existing app."
          else
            echo "Heroku apps API returned HTTP $RESPONSE_CODE"
            cat /tmp/heroku_app.json || true
            echo "::error::Failed to ensure Heroku app exists. Check app name and Heroku key permissions."
            exit 1
          fi

      - name: Download config.py from gist
        if: env.HEROKU_ENABLED == 'true' && env.GIST_RAW_URL != ''
        env:
          GIST_RAW_URL: ${{ env.GIST_RAW_URL }}
        run: |
          echo "Downloading config.py from $GIST_RAW_URL"
          curl -sSL "$GIST_RAW_URL" -o remote_config.py

          echo "First lines of remote_config.py:"
          head -n 20 remote_config.py || true

      - name: Convert config.py (gist) to Heroku config JSON (dynamic keys)
        if: env.HEROKU_ENABLED == 'true' && env.GIST_RAW_URL != ''
        run: |
          python - << 'PY'
          import runpy, json, types

          cfg = runpy.run_path("remote_config.py")

          mapping = {}

          for k, v in cfg.items():
            # Skip Python internals like __name__, __file__, etc.
            if k.startswith("__"):
              continue

            # Skip modules, functions, classes
            if isinstance(v, types.ModuleType) or isinstance(v, type) or callable(v):
              continue

            # Convert lists/tuples like [6310382769] to "6310382769 123456"
            if isinstance(v, (list, tuple)):
              mapping[k] = " ".join(str(x) for x in v)
            else:
              mapping[k] = str(v)

          with open("heroku-config.json", "w") as f:
            json.dump(mapping, f)

          print("Generated heroku-config.json with keys:", ", ".join(mapping.keys()))
          PY

      - name: Apply config vars to Heroku app
        if: env.HEROKU_ENABLED == 'true' && env.GIST_RAW_URL != ''
        env:
          HEROKU_API_KEY: ${{ env.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ env.HEROKU_APP_NAME }}
        run: |
          echo "Patching config vars for app '$HEROKU_APP_NAME' from gist..."
          curl -sS -X PATCH "https://api.heroku.com/apps/$HEROKU_APP_NAME/config-vars" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -d @heroku-config.json

          echo "Config vars have been updated for app '$HEROKU_APP_NAME'."

      - name: Log in to Heroku Container Registry
        if: env.HEROKU_ENABLED == 'true'
        env:
          HEROKU_API_KEY: ${{ env.HEROKU_API_KEY }}
        run: |
          echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com

      - name: Build Docker image for web
        if: env.HEROKU_ENABLED == 'true'
        env:
          HEROKU_APP_NAME: ${{ env.HEROKU_APP_NAME }}
        run: |
          docker build -t registry.heroku.com/${HEROKU_APP_NAME}/web .

      - name: Push Docker image for web
        if: env.HEROKU_ENABLED == 'true'
        env:
          HEROKU_APP_NAME: ${{ env.HEROKU_APP_NAME }}
        run: |
          docker push registry.heroku.com/${HEROKU_APP_NAME}/web

      - name: Release web on Heroku
        if: env.HEROKU_ENABLED == 'true'
        env:
          HEROKU_APP_NAME: ${{ env.HEROKU_APP_NAME }}
          HEROKU_API_KEY: ${{ env.HEROKU_API_KEY }}
        run: |
          IMAGE_ID=$(docker inspect registry.heroku.com/${HEROKU_APP_NAME}/web --format={{.Id}})
          curl -n -X PATCH https://api.heroku.com/apps/${HEROKU_APP_NAME}/formation \
            -d "{\"updates\":[{\"type\":\"web\",\"docker_image\":\"$IMAGE_ID\"}]}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.heroku+json; version=3.docker-releases" \
            -H "Authorization: Bearer $HEROKU_API_KEY"

          echo "Heroku web dyno released for app '${HEROKU_APP_NAME}'."
